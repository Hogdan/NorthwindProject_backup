@model IEnumerable<Category>
<div id="User" style="display:none;" data-email="@User.Identity.Name" data-employee="@User.IsInRole("northwind-employee")"></div>
<div class="container-xxl">
  <h2 class="mt-3"><i class="fas fa-warehouse"></i> Inventory Management</h2>
  <div class="d-flex">
    <dropdown class="mb-3">
      <select class="form-select" id="CategoryId">
        <option value="0" selected disabled>Category</option>
        @foreach (Category c in Model)
        {
          <option value="@c.CategoryId">@c.CategoryName</option>
        }
      </select>
    </dropdown>
  </div>
  <div class="d-flex">
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col">Product Name</th>
          <th scope="col" class="text-end">Quantity Per Unit</th>
          <th scope="col" class="text-end">Price ($)</th>
          <th scope="col" class="text-end">In Stock</th>
          <th scope="col" class="text-end">Units on Order</th>
          <th scope="col" class="text-end">Reorder Level</th>
          <th scope="col" class="text-end">Discontinued</th>
          <th scope="col" class="text-end"></th>
        </tr>
      </thead>
      <tbody id="product_rows">
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    fetchProducts();
  });
  document.getElementById("CategoryId").addEventListener("change", (e) => {
    document.getElementById('product_rows').dataset['id'] = e.target.value;
    fetchProducts();
  });
  async function fetchProducts() {
    const id = document.getElementById('product_rows').dataset['id'];
    const { data: fetchedProducts } = await axios.get(`../../api/category/${id}/product/discontinued/false`);
    let product_rows = "";
    fetchedProducts.map(product => {
      let classes = "";
      if (product.unitsInStock <= product.reorderLevel) classes = 'table-danger';
      else if ((product.unitsInStock - product.reorderLevel) <= product.reorderLevel || product.unitsInStock < 5) {
        classes = 'table-warning';
      }
      const css = classes ? ` class="${classes}"` : '';
      console.log(css);
      product_rows +=
        `<tr${css}>
          <td>${product.productName}</td>
          <td class="text-end">${product.quantityPerUnit}</td>
          <td class="text-end">${product.unitPrice.toFixed(2)}</td>
          <td class="text-end">${product.unitsInStock}</td>
          <td class="text-end">${product.unitsOnOrder}</td>
          <td class="text-end">${product.reorderLevel}</td>
          <td class="text-end">${product.discontinued}</td>
          <td class="text-end"><button onclick="location.href='@Url.Action(action: "Edit", controller: "Product")/${product.productId}'" class="btn btn-sm btn-primary">Edit</button></td>
        </tr>`;
    });
    document.getElementById('product_rows').innerHTML = product_rows;
  }
</script>